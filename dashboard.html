<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnonBrew Dashboard</title>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD5cdmNDck5nHp7idyWYMCMRcg4qhcJIUA",
  authDomain: "anonbrew-543a6.firebaseapp.com",
  databaseURL: "https://anonbrew-543a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anonbrew-543a6",
  storageBucket: "anonbrew-543a6.firebasestorage.app",
  messagingSenderId: "581227381617",
  appId: "1:581227381617:web:d69bd36245547d69fc6cd0",
  measurementId: "G-74KG21Y44F"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
window.firebaseDatabase = database;
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #0B0B0B;
  color: #EEE;
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
.site-header, .site-footer {
  background-color: #111;
  padding: 20px;
  text-align: center;
  border-bottom: 1px solid #333;
}
.site-header h1 { color: #F4C430; margin:0; }
.dashboard-container {
  flex: 1;
  padding: 30px;
  max-width: 900px;
  margin: 20px auto;
  background-color: #1A1A1A;
  border-radius: 12px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.5);
}
.search-bar { margin-bottom: 20px; }
.search-bar input { padding: 10px; width: 60%; border-radius: 8px; border: 1px solid #333; background-color: #111; color: #EEE; }
.search-bar button { padding: 10px 15px; margin-left: 10px; border-radius: 8px; border: none; background-color: #F4C430; color: #0B0B0B; cursor: pointer; font-weight: bold; }
.search-bar button:hover { background-color: #e0b220; }
.add-section { margin-top: 20px; }
.add-section input { padding: 10px; width: 60%; border-radius: 8px; border: 1px solid #333; background-color: #111; color: #EEE; }
.add-section button { padding: 10px 15px; margin-left: 10px; border-radius: 8px; border: none; background-color: #F4C430; color: #0B0B0B; cursor: pointer; font-weight: bold; }
.add-section button:hover { background-color: #e0b220; }
.names-list { margin-top: 20px; }
.name-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s; }
.name-item:hover { background-color: #222; }
.error-message { color: #FF6F61; display: none; margin-top: 10px; }
.success-message { color: #7CFC00; display: none; margin-top: 10px; }
</style>
</head>
<body>

<header class="site-header">
<h1>AnonBrew Dashboard</h1>
</header>

<div class="dashboard-container">
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search Real Name">
    <button id="searchBtn">Search</button>
  </div>

  <div class="add-section">
    <input type="text" id="addNameInput" placeholder="Add new Real Name">
    <button id="addNameBtn">Add Name</button>
    <div class="error-message" id="errorMsg"></div>
    <div class="success-message" id="successMsg"></div>
  </div>

  <div class="names-list" id="namesList">
    <!-- Search results will appear here -->
  </div>
</div>

<footer class="site-footer">&copy; 2025 AnonBrew. All rights reserved.</footer>

<script type="module">
import { ref, get, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const database = window.firebaseDatabase;
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const addNameInput = document.getElementById('addNameInput');
const addNameBtn = document.getElementById('addNameBtn');
const namesList = document.getElementById('namesList');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');

// Login check using sessionStorage
const loggedInUser = sessionStorage.getItem('username');
if (!loggedInUser) {
  window.location.href = "index.html";
}

async function loadNames(filter="") {
  namesList.innerHTML = "";
  const snapshot = await get(ref(database, 'names'));
  const names = snapshot.val() || {};
  const filterLower = filter.toLowerCase();
  let foundSimilar = false;

  for (const key in names) {
    const nameData = names[key];
    const nameLower = nameData.realName.toLowerCase();
    // Exact match
    if(nameLower === filterLower){
      const div = document.createElement('div');
      div.classList.add('name-item');
      div.textContent = nameData.realName + " (Exact match)";
      div.addEventListener('click', () => {
        window.location.href = `profile.html?name=${encodeURIComponent(nameData.realName)}`;
      });
      namesList.appendChild(div);
      foundSimilar = true;
    }
    // Similar match (partial)
    else if(nameLower.includes(filterLower) && filterLower.length>0){
      const div = document.createElement('div');
      div.classList.add('name-item');
      div.textContent = nameData.realName + " (Similar)";
      div.addEventListener('click', () => {
        window.location.href = `profile.html?name=${encodeURIComponent(nameData.realName)}`;
      });
      namesList.appendChild(div);
      foundSimilar = true;
    }
  }

  // If no similar or exact match, show "Add this person" button
  if(!foundSimilar && filter){
    const addDiv = document.createElement('div');
    addDiv.classList.add('name-item');
    addDiv.style.backgroundColor = "#222";
    addDiv.style.color = "#7CFC00";
    addDiv.style.fontWeight = "bold";
    addDiv.textContent = `Add "${filter}"`;
    addDiv.addEventListener('click', async () => {
      const ipResponse = await fetch('https://api.ipify.org?format=json');
      const ipData = await ipResponse.json();
      const nameRef = push(ref(database, 'names'));
      await set(nameRef, {
        realName: filter,
        addedBy: loggedInUser,
        ip: ipData.ip,
        details: "",
        reviews: {}
      });
      loadNames(); // refresh list
    });
    namesList.appendChild(addDiv);
  }
}

// Initial load
loadNames();

searchBtn.addEventListener('click', () => {
  loadNames(searchInput.value.trim());
});

// Add new name manually
addNameBtn.addEventListener('click', async () => {
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';
  const newName = addNameInput.value.trim();
  if (!newName) return;

  const snapshot = await get(ref(database, 'names'));
  const names = snapshot.val() || {};
  const lowerNew = newName.toLowerCase();

  for (const key in names) {
    if (names[key].realName.toLowerCase() === lowerNew) {
      errorMsg.textContent = "This name already exists!";
      errorMsg.style.display = 'block';
      return;
    }
  }

  const ipResponse = await fetch('https://api.ipify.org?format=json');
  const ipData = await ipResponse.json();

  const nameRef = push(ref(database, 'names'));
  await set(nameRef, {
    realName: newName,
    addedBy: loggedInUser,
    ip: ipData.ip,
    details: "",
    reviews: {}
  });

  successMsg.textContent = "Name added successfully!";
  successMsg.style.display = 'block';
  addNameInput.value = "";
  loadNames();
});
</script>

</body>
</html>